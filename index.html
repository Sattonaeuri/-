<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í˜„ì¥ ì‚¬ì§„ Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/piexifjs/1.0.6/piexif.min.js"></script>
    <style>
        /* ë‹¤í¬ ëª¨ë“œ ë° OLED ìµœì í™” */
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #000000; color: #ffffff; }
        .card { background: #1c1c1e; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); box-sizing: border-box; }
        h3 { margin: 0 0 12px 0; font-size: 16px; border-bottom: 1px solid #333; padding-bottom: 8px; color: #e5e5ea; }
        
        /* ë ˆì´ì•„ì›ƒ ìµœì í™”: 1ì—´ 65px ë° ìš°ì¸¡ ì—¬ë°± í™•ë³´ */
        .row { display: flex; gap: 10px; margin-bottom: 8px; align-items: stretch; width: 100%; }
        .col-key { width: 65px; flex: none !important; font-weight: bold; background: #2c2c2e; color: #a1a1a6; border: 1px solid #3a3a3c; padding: 12px 5px; border-radius: 8px; text-align: center; font-size: 13px; box-sizing: border-box; }
        input, select { flex: 1; min-width: 0; padding: 12px; border: 1px solid #3a3a3c; border-radius: 8px; font-size: 15px; background: #2c2c2e; color: #ffffff; box-sizing: border-box; }
        
        /* ì…ë ¥ ìƒì ë‚´ë¶€ ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .input-wrapper { position: relative; flex: 1; display: flex; align-items: center; min-width: 0; }
        .input-wrapper input { flex: 1; min-width: 0; }
        .input-with-clear { padding-right: 40px !important; }
        .clear-btn { 
            position: absolute; 
            right: 8px; 
            background: #8e8e93; 
            border: none; 
            border-radius: 50%; 
            width: 24px; 
            height: 24px; 
            color: white; 
            font-size: 14px; 
            cursor: pointer; 
            display: none;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .clear-btn:active { background: #636366; }
        
        /* ë‚ ì§œ ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        input[type="date"] {
            color-scheme: dark;
            -webkit-appearance: none;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        
        button { padding: 15px; border-radius: 10px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-blue { background: #0a84ff; color: white; width: 100%; margin-top: 10px; }
        .btn-green { background: #30d158; color: white; width: 100%; margin-top: 10px; }
        .btn-red { background: #ff453a; color: white; width: 70px; font-size: 13px; flex-shrink: 0; }
        .btn-gray { background: #8e8e93; color: white; width: 70px; font-size: 13px; flex-shrink: 0; }
        .btn-orange { background: #ff9f0a; color: white; width: 100%; margin-top: 10px; }
        #status { text-align: center; margin-top: 15px; font-weight: 600; color: #0a84ff; }
        #openFilesBtn { display: none; }
    </style>
</head>
<body>

<div class="card">
    <h3>ğŸ“‹ í‘œ ë‚´ìš© ì…ë ¥</h3>
    <div id="tableFields"></div>
</div>

<div class="card">
    <h3>ğŸ’¾ í…œí”Œë¦¿ ê´€ë¦¬</h3>
    <div class="row">
        <select id="templateList" onchange="loadTemplate()"><option value="">í…œí”Œë¦¿ ì„ íƒ</option></select>
        <button class="btn-red" onclick="deleteTemplate()">ì‚­ì œ</button>
    </div>
    <div class="row">
        <div class="input-wrapper">
            <input type="text" id="newTemplateName" class="input-with-clear" placeholder="ìƒˆ ì´ë¦„" oninput="toggleClearBtn()">
            <button class="clear-btn" id="clearNameBtn" onclick="clearTemplateName()">âœ•</button>
        </div>
        <button class="btn-gray" onclick="saveTemplate()">ì €ì¥</button>
    </div>
</div>

<div class="card">
    <input type="file" id="imageInput" multiple accept="image/jpeg" style="display: none;">
    <button class="btn-blue" onclick="document.getElementById('imageInput').click()">ğŸ“¸ ì‚¬ì§„ ì„ íƒ & ì‘ì—… ì‹œì‘</button>
    <div id="status">ëŒ€ê¸° ì¤‘...</div>
    <button id="openFilesBtn" class="btn-green" onclick="openFilesApp()">ğŸ“‚ íŒŒì¼ ì•± ì—´ê¸°</button>
</div>

<div class="card">
    <h3>ğŸ’¾ í…œí”Œë¦¿ ë°±ì—… & ë³µì›</h3>
    <button class="btn-blue" onclick="exportTemplates()">ğŸ“¤ í…œí”Œë¦¿ ë‚´ë³´ë‚´ê¸° (JSON)</button>
    <input type="file" id="importInput" accept="application/json" style="display: none;" onchange="importTemplates(event)">
    <button class="btn-green" onclick="document.getElementById('importInput').click()">ğŸ“¥ í…œí”Œë¦¿ ê°€ì ¸ì˜¤ê¸° (JSON)</button>
</div>

<div class="card">
    <h3>ğŸ”„ ì•± ì—…ë°ì´íŠ¸</h3>
    <button class="btn-orange" onclick="updateApp()">ğŸ”„ ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸</button>
    <div style="text-align: center; margin-top: 10px; font-size: 13px; color: #8e8e93;">ìºì‹œë¥¼ ì‚­ì œí•˜ê³  ìµœì‹  ë²„ì „ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤</div>
</div>

<script>
    const storageKey = 'photo_pro_v7_final';
    const statusText = document.getElementById('status');
    const openFilesBtn = document.getElementById('openFilesBtn');
    const today = new Date();
    const dateStr = `${today.getFullYear()}ë…„ ${String(today.getMonth() + 1).padStart(2, '0')}ì›” ${String(today.getDate()).padStart(2, '0')}ì¼`;
    
    let currentTemplateName = ""; // í˜„ì¬ ì„ íƒëœ í…œí”Œë¦¿ ì´ë¦„ ì €ì¥

    let currentData = [
        {k: "ê³µì‚¬ëª…", v: ""}, {k: "ì‹œë£Œë²ˆí˜¸", v: ""},
        {k: "ì¼ì", v: dateStr}, {k: "ì±„ì·¨êµ¬ë¶„", v: ""}, {k: "ì¡°ì‚¬ì", v: ""}
    ];

    // ë‚ ì§œë¥¼ "YYYYë…„ MMì›” DDì¼" í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    function formatDateToKorean(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}ë…„ ${month}ì›” ${day}ì¼`;
    }

    // "YYYYë…„ MMì›” DDì¼" í˜•ì‹ì„ "YYYY-MM-DD"ë¡œ ë³€í™˜
    function koreanToISO(koreanDate) {
        const match = koreanDate.match(/(\d{4})ë…„ (\d{2})ì›” (\d{2})ì¼/);
        return match ? `${match[1]}-${match[2]}-${match[3]}` : '';
    }

    function renderFields() {
        const container = document.getElementById('tableFields');
        container.innerHTML = '';
        currentData.forEach((item, i) => {
            const row = document.createElement('div');
            row.className = 'row';
            
            // ë‚ ì§œ í•„ë“œì¸ ê²½ìš° date input ì‚¬ìš© (X ë²„íŠ¼ ì—†ìŒ)
            if (item.k === "ì¼ì") {
                const isoDate = koreanToISO(item.v);
                row.innerHTML = `<input type="text" class="col-key" value="${item.k}" oninput="currentData[${i}].k=this.value">
                                 <input type="date" value="${isoDate}" onchange="updateDateField(${i}, this.value)">`;
            } else {
                // ì¼ë°˜ í•„ë“œ: 1ì—´ì€ X ë²„íŠ¼ ì—†ìŒ, 2ì—´ë§Œ X ë²„íŠ¼ ì ìš©
                row.innerHTML = `<input type="text" class="col-key" value="${item.k}" oninput="currentData[${i}].k=this.value">
                                 <div class="input-wrapper">
                                     <input type="text" class="input-with-clear" value="${item.v}" oninput="currentData[${i}].v=this.value; toggleFieldClearBtn(${i}, 'value')">
                                     <button class="clear-btn" id="clearValue${i}" onclick="clearFieldInput(${i}, 'value')">âœ•</button>
                                 </div>`;
            }
            container.appendChild(row);
            
            // ì´ˆê¸° X ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ ì„¤ì • (2ì—´ë§Œ)
            if (item.k !== "ì¼ì") {
                setTimeout(() => {
                    toggleFieldClearBtn(i, 'value');
                }, 0);
            }
        });
    }

    // ë‚ ì§œ í•„ë“œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateDateField(index, isoDate) {
        if (isoDate) {
            const [year, month, day] = isoDate.split('-');
            currentData[index].v = `${year}ë…„ ${month}ì›” ${day}ì¼`;
        }
    }

    function getShortDate(str) {
        const match = str.match(/(\d{4})ë…„ (\d{2})ì›” (\d{2})ì¼/);
        return match ? (match[1].substring(2) + match[2] + match[3]) : "000000";
    }

    // EXIFì—ì„œ ì´¬ì˜ ì‹œê°„ ì¶”ì¶œ
    async function getExifDateTime(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                try {
                    const exifObj = piexif.load(e.target.result);
                    const dateTime = exifObj['0th'][piexif.ImageIFD.DateTime] || 
                                   exifObj['Exif'][piexif.ExifIFD.DateTimeOriginal] || 
                                   '';
                    if (dateTime) {
                        // "2026:01:19 14:30:45" í˜•ì‹ì„ Dateë¡œ ë³€í™˜
                        const [date, time] = dateTime.split(' ');
                        const [year, month, day] = date.split(':');
                        const [hour, min, sec] = time.split(':');
                        resolve(new Date(year, month - 1, day, hour, min, sec));
                    } else {
                        resolve(new Date(0)); // EXIF ì—†ìœ¼ë©´ ê°€ì¥ ì˜¤ë˜ëœ ì‹œê°„ìœ¼ë¡œ
                    }
                } catch (err) {
                    resolve(new Date(0));
                }
            };
        });
    }

    document.getElementById('imageInput').addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if (!files.length) return;
        
        openFilesBtn.style.display = 'none';
        statusText.innerText = 'ì´¬ì˜ ì‹œê°„ ë¶„ì„ ì¤‘...';
        
        // íŒŒì¼ê³¼ ì´¬ì˜ì‹œê°„ì„ í•¨ê»˜ ì €ì¥
        const filesWithTime = await Promise.all(
            files.map(async (file) => ({
                file: file,
                time: await getExifDateTime(file)
            }))
        );
        
        // ì´¬ì˜ ì‹œê°„ ìˆœìœ¼ë¡œ ì •ë ¬ (ë¹ ë¥¸ ì‹œê°„ ë¨¼ì €)
        filesWithTime.sort((a, b) => a.time - b.time);
        const sortedFiles = filesWithTime.map(item => item.file);
        
        const zip = new JSZip();
        
        // ZIP íŒŒì¼ëª…: [í…œí”Œë¦¿ì´ë¦„ or ê³µì‚¬ëª…] [ì‹œë£Œë²ˆí˜¸] [ë‚ ì§œ]
        const baseTitle = currentTemplateName || currentData[0].v || "í˜„ì¥ì‚¬ì§„";
        const sampleNumber = currentData[1].v; // ì‹œë£Œë²ˆí˜¸
        const datePart = getShortDate(currentData[2].v);
        
        // ì‹œë£Œë²ˆí˜¸ê°€ ìˆìœ¼ë©´ í¬í•¨, ì—†ìœ¼ë©´ ì œì™¸
        const zipFileName = sampleNumber 
            ? `${baseTitle} ${sampleNumber} ${datePart}`.trim()
            : `${baseTitle} ${datePart}`.trim();

        // ê°œë³„ ì‚¬ì§„ íŒŒì¼ëª…: ì‹œë£Œë²ˆí˜¸ (1), ì‹œë£Œë²ˆí˜¸ (2), ...
        const photoBaseName = sampleNumber || "ì‚¬ì§„";
        
        for (let i = 0; i < sortedFiles.length; i++) {
            statusText.innerText = `${i+1}/${sortedFiles.length}ê°œ ì²˜ë¦¬ ì¤‘... (EXIF ë³µì‚¬ ì¤‘)`;
            const blob = await processImage(sortedFiles[i]);
            zip.file(`${photoBaseName} (${i+1}).jpg`, blob);
        }

        const content = await zip.generateAsync({type: "blob"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = `${zipFileName}.zip`;
        link.click();
        statusText.innerText = "ì €ì¥ ì™„ë£Œ!";
        openFilesBtn.style.display = 'block';
    });

    async function processImage(file) {
        return new Promise(res => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const originalDataUrl = e.target.result;
                const img = new Image();
                img.src = originalDataUrl;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width; canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    const rowH = canvas.height * 0.045;
                    const fontSize = rowH * 0.75;
                    ctx.font = `${fontSize}px Arial`;
                    ctx.textBaseline = 'middle';
                    
                    let maxVWidth = 0;
                    currentData.forEach(d => {
                        const w = ctx.measureText(d.v).width;
                        if(w > maxVWidth) maxVWidth = w;
                    });
                    const keyWidth = ctx.measureText("ê³µì‚¬ëª…ì¼ì").width;
                    const padding = 40;
                    const tableW = keyWidth + maxVWidth + (padding * 4);
                    const tableH = rowH * 5;
                    const x = 60, y = canvas.height - tableH - 60;

                    ctx.fillStyle = "white"; ctx.fillRect(x, y, tableW, tableH);
                    ctx.strokeStyle = "black"; ctx.lineWidth = canvas.width * 0.0015;
                    ctx.fillStyle = "black";

                    currentData.forEach((item, i) => {
                        const cy = y + (i * rowH);
                        ctx.strokeRect(x, cy, tableW, rowH);
                        const splitX = x + keyWidth + (padding * 2);
                        ctx.beginPath(); ctx.moveTo(splitX, cy); ctx.lineTo(splitX, cy+rowH); ctx.stroke();
                        ctx.fillText(item.k, x + padding, cy + (rowH * 0.5));
                        ctx.fillText(item.v, splitX + padding, cy + (rowH * 0.5));
                    });

                    canvas.toBlob(blob => {
                        const reader2 = new FileReader();
                        reader2.readAsDataURL(blob);
                        reader2.onload = (e2) => {
                            const newDataUrl = e2.target.result;
                            try {
                                const exifObj = piexif.load(originalDataUrl);
                                const exifStr = piexif.dump(exifObj);
                                const finalDataUrl = piexif.insert(exifStr, newDataUrl);
                                fetch(finalDataUrl).then(r => r.blob()).then(res);
                            } catch (err) {
                                res(blob);
                            }
                        };
                    }, "image/jpeg", 0.95);
                }
            }
        });
    }

    function openFilesApp() {
        window.location.href = 'shareddocuments://';
    }

    function saveTemplate() {
        const name = document.getElementById('newTemplateName').value;
        if(!name) return alert("ì´ë¦„ ì…ë ¥");
        let t = JSON.parse(localStorage.getItem(storageKey) || '{}');
        t[name] = JSON.parse(JSON.stringify(currentData));
        localStorage.setItem(storageKey, JSON.stringify(t));
        currentTemplateName = name;
        updateTmplList();
        document.getElementById('templateList').value = name; // ì„ íƒ ìƒíƒœ ìœ ì§€
        alert("ì €ì¥ ì„±ê³µ");
    }

    function loadTemplate() {
        const n = document.getElementById('templateList').value;
        const nameInput = document.getElementById('newTemplateName');
        
        if(!n) { 
            currentTemplateName = ""; 
            nameInput.value = ""; // ì„ íƒ í•´ì œ ì‹œ ì…ë ¥ì¹¸ë„ ë¹„ìš°ê¸°
            toggleClearBtn(); // X ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            return; 
        }
        
        const t = JSON.parse(localStorage.getItem(storageKey) || '{}');
        if(t[n]) { 
            currentData = t[n]; 
            currentData[2].v = dateStr; // ë‚ ì§œëŠ” í•­ìƒ ì˜¤ëŠ˜ë¡œ ì´ˆê¸°í™”
            currentTemplateName = n;
            nameInput.value = n; // í…œí”Œë¦¿ ì´ë¦„ì„ ì…ë ¥ì¹¸ì— í‘œì‹œ
            toggleClearBtn(); // X ë²„íŠ¼ í‘œì‹œ
            renderFields(); 
        }
    }

    function deleteTemplate() {
        const n = document.getElementById('templateList').value;
        if(!n || !confirm("ì‚­ì œí• ê¹Œìš”?")) return;
        let t = JSON.parse(localStorage.getItem(storageKey) || '{}');
        delete t[n];
        localStorage.setItem(storageKey, JSON.stringify(t));
        if(currentTemplateName === n) {
            currentTemplateName = "";
            document.getElementById('newTemplateName').value = ""; // ì…ë ¥ì¹¸ë„ ë¹„ìš°ê¸°
        }
        updateTmplList();
    }

    function updateTmplList() {
        const s = document.getElementById('templateList');
        const t = JSON.parse(localStorage.getItem(storageKey) || '{}');
        s.innerHTML = '<option value="">í…œí”Œë¦¿ ì„ íƒ</option>';
        for(let n in t) s.innerHTML += `<option value="${n}">${n}</option>`;
    }

    // í…œí”Œë¦¿ ì´ë¦„ ì…ë ¥ ìƒì ì§€ìš°ê¸°
    function clearTemplateName() {
        document.getElementById('newTemplateName').value = '';
        document.getElementById('clearNameBtn').style.display = 'none';
    }

    // ì…ë ¥ ìƒìì— ë‚´ìš©ì´ ìˆì„ ë•Œë§Œ X ë²„íŠ¼ í‘œì‹œ
    function toggleClearBtn() {
        const input = document.getElementById('newTemplateName');
        const btn = document.getElementById('clearNameBtn');
        btn.style.display = input.value ? 'flex' : 'none';
    }

    // í‘œ í•„ë“œ ì…ë ¥ ìƒì ì§€ìš°ê¸°
    function clearFieldInput(index, type) {
        if (type === 'key') {
            currentData[index].k = '';
            renderFields();
        } else {
            currentData[index].v = '';
            renderFields();
        }
    }

    // í‘œ í•„ë“œ X ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
    function toggleFieldClearBtn(index, type) {
        const btnId = type === 'key' ? `clearKey${index}` : `clearValue${index}`;
        const btn = document.getElementById(btnId);
        if (!btn) return;
        
        const value = type === 'key' ? currentData[index].k : currentData[index].v;
        btn.style.display = value ? 'flex' : 'none';
    }

    // í…œí”Œë¦¿ ë‚´ë³´ë‚´ê¸° (JSON íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ)
    function exportTemplates() {
        const templates = localStorage.getItem(storageKey);
        if (!templates || templates === '{}') {
            alert('ì €ì¥ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(templates);
        const downloadAnchor = document.createElement('a');
        downloadAnchor.setAttribute("href", dataStr);
        downloadAnchor.setAttribute("download", "photo_pro_templates.json");
        downloadAnchor.click();
        alert('í…œí”Œë¦¿ì„ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤!');
    }

    // í…œí”Œë¦¿ ê°€ì ¸ì˜¤ê¸° (JSON íŒŒì¼ ì—…ë¡œë“œ)
    function importTemplates(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                
                // ê¸°ì¡´ í…œí”Œë¦¿ê³¼ ë³‘í•©í• ì§€ í™•ì¸
                const existing = JSON.parse(localStorage.getItem(storageKey) || '{}');
                const existingCount = Object.keys(existing).length;
                
                let shouldMerge = true;
                if (existingCount > 0) {
                    shouldMerge = confirm(`ê¸°ì¡´ í…œí”Œë¦¿ ${existingCount}ê°œê°€ ìˆìŠµë‹ˆë‹¤.\n\ní™•ì¸: ê¸°ì¡´ í…œí”Œë¦¿ê³¼ ë³‘í•© (ì¤‘ë³µ ì´ë¦„ì€ ë®ì–´ì“°ê¸°)\nì·¨ì†Œ: ê¸°ì¡´ í…œí”Œë¦¿ ì‚­ì œ í›„ ê°€ì ¸ì˜¤ê¸°`);
                }
                
                if (shouldMerge) {
                    // ë³‘í•©
                    const merged = {...existing, ...importedData};
                    localStorage.setItem(storageKey, JSON.stringify(merged));
                } else {
                    // êµì²´
                    localStorage.setItem(storageKey, JSON.stringify(importedData));
                }
                
                updateTmplList();
                alert('í…œí”Œë¦¿ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤!');
                document.getElementById('importInput').value = ''; // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            } catch (error) {
                alert('ì˜¬ë°”ë¥¸ í…œí”Œë¦¿ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
                console.error(error);
            }
        };
        reader.readAsText(file);
    }

    // ì•± ì—…ë°ì´íŠ¸ (ìºì‹œ ì‚­ì œ ë° ìƒˆë¡œê³ ì¹¨)
    function updateApp() {
        if (confirm('ì•±ì„ ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.\nìºì‹œê°€ ì‚­ì œë˜ê³  í˜ì´ì§€ê°€ ìƒˆë¡œê³ ì¹¨ë©ë‹ˆë‹¤.\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            // Service Worker ìºì‹œ ì‚­ì œ
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for (let name of names) {
                        caches.delete(name);
                    }
                });
            }
            
            // ê°•ì œ ìƒˆë¡œê³ ì¹¨ (ìºì‹œ ë¬´ì‹œ)
            window.location.reload(true);
        }
    }

    window.onload = () => { renderFields(); updateTmplList(); };
</script>
</body>
</html>
